services:
  # --- 1. DATA BASE ---
  db:
    image: postgres:15
    container_name: postgres_seguro
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./API_DB/postgres_data:/var/lib/postgresql/data
    # healthcheck:
    #   test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    restart: always

  # --- 2. API DB ---
  api-db:
    build: ./API_DB
    container_name: api_database
    ports:
      - "8000:8000"
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
    restart: always

  # --- 3. API WAQI REALTIME ---
  api_manager:
    build: ./API_Service
    container_name: api_manager_waqi
    depends_on:
      - api-db
    environment:
      - PYTHONUNBUFFERED=1
      - WAQI_API_TOKEN=${WAQI_API_TOKEN} 
      - LONDON_BOUNDS=${LONDON_BOUNDS}
      - SCAN_INTERVAL=${SCAN_INTERVAL}
      - API_URL=http://api-db:8000/insertar-datos
      - API_TOKEN_APIDB_REALTIME=${API_TOKEN_APIDB_REALTIME} 
    restart: always

  # --- 4. API OPENAQ HISTORICAL DATA ---
  historical_data:
    build: ./HistoricalData
    container_name: historical_manager_openaq
    depends_on:
      - api-db
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAQ_API_KEY=${OPENAQ_API_KEY}
      - OPENAQ_BOUNDS=${OPENAQ_BOUNDS}
      - API_URL=http://api-db:8000/insertar-datos
      - API_TOKEN_APIDB_HISTORICAL=${API_TOKEN_APIDB_HISTORICAL}
    restart: always

  # --- 5. DBT ---
  dbt_transform:
    build: ./DBT
    container_name: dbt_london
    depends_on:
      - db
    volumes:
      - ./DBT:/app
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    restart: always

    # --- 6. MAPA PLOTLY (DASHBOARD) ---
  mapa_plotly:
    build: ./mapa_calidad_aire
    container_name: mapa_calidad_aire
    ports:
      - "8050:8050"
    depends_on:
      - db
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - WAQI_API_TOKEN=${WAQI_API_TOKEN}
      - LONDON_BOUNDS=${LONDON_BOUNDS}
    restart: always

  # --- 7. ALERT NOTIFIER (TELEGRAM) ---
  # NOTE: When enabling the healthcheck in the db service, uncomment the depends_on block below
  # depends_on:
  #   db:
  #     condition: service_healthy
  #   dbt_transform:
  #     condition: service_started
  alert-notifier:
    build: ./AlertNotifier
    container_name: alert_notifier_telegram
    depends_on:
      - db
      - dbt_transform
    environment:
      - PYTHONUNBUFFERED=1
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - ALERT_CHECK_INTERVAL=${ALERT_CHECK_INTERVAL}
    restart: always

      # --- 6. GRAFAMA ---
  grafana:
    build: ./grafana
    container_name: grafana_london
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/grafana_vis:/etc/grafana/grafana_vis
    depends_on:
      - db
    environment:
      
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    restart: always